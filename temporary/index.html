<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ReviewIQ - Enterprise Dashboard</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Tailwind Config -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' },
                        sentiment: { positive: '#10B981', neutral: '#F59E0B', negative: '#EF4444' },
                        surface: '#ffffff', background: '#f8fafc',
                    },
                    boxShadow: {
                        'soft': '0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03)',
                        'border': '0 0 0 1px rgba(226, 232, 240, 1)'
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #334155;
        }

        .glass-card {
            background: rgba(255, 255, 255, 1);
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .glass-card:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .nav-item.active {
            background-color: #f1f5f9;
            color: #2563eb;
            font-weight: 600;
        }

        .nav-item.active i {
            color: #2563eb;
        }

        .status-badge {
            padding: 0.25rem 0.6rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-positive {
            background-color: #d1fae5;
            color: #065f46;
        }

        .badge-neutral {
            background-color: #fef3c7;
            color: #92400e;
        }

        .badge-critical {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .badge-responded {
            background-color: #f1f5f9;
            color: #475569;
            border: 1px solid #cbd5e1;
        }
    </style>
</head>

<body class="flex h-screen overflow-hidden relative">

    <!-- Login Overlay -->
    <div id="loginOverlay"
        class="fixed inset-0 bg-gray-900 bg-opacity-95 z-50 flex flex-col items-center justify-center p-4 transition-opacity duration-300">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-brand-500"></div>
            <div
                class="bg-brand-50 text-brand-600 w-16 h-16 rounded-2xl mx-auto flex items-center justify-center mb-6 shadow-sm border border-brand-100">
                <i class="fa-solid fa-chart-line text-3xl"></i>
            </div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">ReviewIQ</h1>
            <p class="text-gray-500 text-sm mb-8">Sign in with your authorized Google account to access the enterprise
                dashboard.</p>
            <button id="googleSignInBtn"
                class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-medium py-3 px-4 rounded-xl transition flex items-center justify-center gap-3 shadow-sm">
                <img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google Logo"
                    class="w-5 h-5">
                Sign in with Google
            </button>
            <div id="loginError"
                class="hidden mt-4 text-sm text-red-600 font-medium bg-red-50 p-3 rounded-lg border border-red-100">
                Authentication failed. Please try again.
            </div>
        </div>
    </div>

    <!-- MAIN WORKSPACE -->
    <div id="appWorkspace" class="flex h-full w-full hidden opacity-0 transition-opacity duration-500">
        <!-- üìå SIDEBAR NAVIGATION -->
        <aside
            class="w-64 bg-surface border-r border-gray-200 flex flex-col justify-between hidden md:flex shrink-0 z-20">
            <div>
                <!-- Logo -->
                <div class="h-16 flex items-center px-6 border-b border-gray-100">
                    <div class="bg-brand-600 text-white p-1.5 rounded-lg mr-3 shadow-sm">
                        <i class="fa-solid fa-chart-line text-lg"></i>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight text-gray-900">Review<span
                            class="text-brand-600">IQ</span></h1>
                </div>

                <!-- Nav Links -->
                <nav class="p-4 space-y-1 mt-2">
                    <button data-target="tab-overview"
                        class="tab-btn w-full text-left nav-item active flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition">
                        <i class="fa-solid fa-house w-5 text-gray-400"></i> Dashboard Overview
                    </button>
                    <button data-target="tab-inbox"
                        class="tab-btn w-full text-left nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition">
                        <i class="fa-solid fa-comments w-5 text-gray-400"></i> Inbox & Responses
                        <span id="sidebar-critical-count"
                            class="ml-auto bg-red-100 text-red-600 py-0.5 px-2 rounded-full text-xs font-bold">0</span>
                    </button>
                    <button data-target="tab-reports"
                        class="tab-btn w-full text-left nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition">
                        <i class="fa-solid fa-chart-pie w-5 text-gray-400"></i> Monthly Reports
                    </button>
                    <button data-target="tab-performance"
                        class="tab-btn w-full text-left nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition">
                        <i class="fa-solid fa-store w-5 text-gray-400"></i> Branch Performance
                    </button>
                    <button data-target="tab-staff"
                        class="tab-btn w-full text-left nav-item flex items-center gap-3 px-3 py-2.5 rounded-lg text-sm text-gray-600 hover:bg-gray-50 transition">
                        <i class="fa-solid fa-users w-5 text-gray-400"></i> Staff Analytics
                    </button>
                    <div class="pt-4 mt-4 border-t border-gray-100">
                        <p class="px-3 text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2">Integrations
                        </p>
                        <button id="openAddRestaurantBtn"
                            class="hidden w-full text-left nav-item flex items-center gap-3 px-3 py-2 text-sm text-gray-600 hover:bg-gray-50 rounded-lg transition group">
                            <i class="fa-brands fa-google w-5 text-gray-400 group-hover:text-blue-500"></i> Add
                            Restaurant & Sync <span class="ml-auto w-2 h-2 bg-green-500 rounded-full"></span>
                        </button>
                    </div>
                </nav>
            </div>

            <!-- User Profile Bottom -->
            <div class="p-4 border-t border-gray-200 flex items-center justify-between">
                <div class="flex items-center gap-3 w-full p-2 rounded-lg">
                    <img id="userAvatar" src="https://ui-avatars.com/api/?name=Loading&background=1d4ed8&color=fff"
                        class="w-9 h-9 rounded-full ring-2 ring-white">
                    <div class="flex-1 min-w-0">
                        <p id="userNameDisplay" class="text-sm font-semibold text-gray-900 truncate">Loading...</p>
                        <p id="userRoleDisplay" class="text-[10px] text-gray-500 font-semibold uppercase truncate">ROLE
                            ‚Ä¢ All Branches</p>
                    </div>
                </div>
                <button id="logoutBtn" title="Sign Out" class="text-gray-400 hover:text-red-500 transition px-2"><i
                        class="fa-solid fa-arrow-right-from-bracket"></i></button>
            </div>
        </aside>

        <!-- üìå MAIN CONTENT WORKSPACE -->
        <main class="flex-1 flex flex-col min-w-0 bg-background overflow-hidden relative">

            <!-- Top Nav Header -->
            <header
                class="h-16 bg-surface border-b border-gray-200 flex items-center justify-between px-6 lg:px-8 z-10 shrink-0">
                <button class="md:hidden text-gray-500 hover:text-gray-700"><i
                        class="fa-solid fa-bars text-xl"></i></button>

                <!-- Global Search & Filters -->
                <div class="hidden md:flex items-center gap-4 flex-1">
                    <div class="relative w-96">
                        <i
                            class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                        <input type="text" id="globalSearchInput" placeholder="Search reviews, staff, or branches..."
                            class="w-full bg-gray-50 border border-gray-200 text-sm rounded-lg pl-9 pr-3 py-2 text-gray-700 focus:outline-none focus:ring-2 focus:ring-brand-500 shadow-sm">
                    </div>
                    <div class="h-6 w-px bg-gray-200 mx-2"></div>

                    <!-- Branch Filter -->
                    <div class="relative">
                        <select id="branchSelector"
                            class="appearance-none bg-white border border-gray-200 text-gray-700 text-sm font-medium rounded-lg pl-3 pr-8 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500 shadow-sm cursor-pointer hover:bg-gray-50">
                            <option value="all">üè¢ All Branches Overview</option>
                        </select>
                        <i
                            class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i>
                    </div>

                    <!-- Date Filter -->
                    <div class="relative">
                        <select
                            class="appearance-none bg-white border border-gray-200 text-gray-700 text-sm font-medium rounded-lg pl-3 pr-8 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500 shadow-sm cursor-pointer hover:bg-gray-50">
                            <option>üìÖ Last 30 Days</option>
                        </select>
                        <i
                            class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 text-xs pointer-events-none"></i>
                    </div>
                </div>

                <!-- Right Actions -->
                <div class="flex items-center gap-3">
                    <button
                        class="w-9 h-9 rounded-full bg-white border border-gray-200 flex items-center justify-center text-gray-500 shadow-sm relative"><i
                            class="fa-regular fa-bell"></i><span
                            class="absolute top-0 right-0 w-2.5 h-2.5 bg-red-500 rounded-full border-2 border-white"></span></button>
                </div>
            </header>

            <!-- Main Scrollable Area -->
            <div class="flex-1 overflow-y-auto p-6 lg:p-8 no-scrollbar">

                <div class="mb-8 flex justify-between items-end">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 tracking-tight">Enterprise Overview</h2>
                        <p class="text-sm text-gray-500 mt-1">Aggregating data from Google Places & Internal Feedback.
                        </p>
                    </div>
                    <div
                        class="flex items-center gap-2 text-xs font-medium text-gray-500 bg-white px-3 py-1.5 rounded-full border border-gray-200 shadow-sm">
                        <i class="fa-solid fa-rotate text-brand-500"></i> Auto-synced 2 mins ago
                    </div>
                </div>

                <!-- TABS CONTAINER -->
                <div id="tab-overview" class="tab-pane block">
                    <!-- 1Ô∏è‚É£ TOP SUMMARY CARDS -->
                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4 mb-8">
                        <div class="glass-card p-5">
                            <div class="flex justify-between items-start mb-4">
                                <p class="text-sm font-semibold text-gray-500">Total Reviews</p>
                                <div
                                    class="w-8 h-8 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center">
                                    <i class="fa-solid fa-users"></i>
                                </div>
                            </div>
                            <h3 id="stat-total" class="text-3xl font-bold text-gray-900">0</h3>
                        </div>
                        <div class="glass-card p-5">
                            <div class="flex justify-between items-start mb-4">
                                <p class="text-sm font-semibold text-gray-500">Avg Rating</p>
                                <div
                                    class="w-8 h-8 rounded-full bg-yellow-50 text-yellow-500 flex items-center justify-center">
                                    <i class="fa-solid fa-star"></i>
                                </div>
                            </div>
                            <h3 class="text-3xl font-bold text-gray-900"><span id="stat-avg">0.0</span><span
                                    class="text-lg text-gray-400 font-normal">/5</span></h3>
                        </div>
                        <div class="glass-card p-5 relative overflow-hidden">
                            <div id="stat-sentiment-bar"
                                class="absolute bottom-0 left-0 h-1 bg-emerald-500 w-[0%] rounded-b-xl transition-all duration-1000">
                            </div>
                            <div class="flex justify-between items-start mb-4">
                                <p class="text-sm font-semibold text-gray-500">Sentiment Health</p>
                                <div
                                    class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center">
                                    <i class="fa-solid fa-heart-pulse"></i>
                                </div>
                            </div>
                            <h3 class="text-3xl font-bold text-gray-900"><span id="stat-sentiment">0</span><span
                                    class="text-lg text-gray-400 font-normal">%</span></h3>
                        </div>
                        <div class="glass-card p-5 border-l-4 border-l-red-500">
                            <div class="flex justify-between items-start mb-4">
                                <p class="text-sm font-semibold text-gray-500">Critical Alerts</p>
                                <div
                                    class="w-8 h-8 rounded-full bg-red-50 text-red-600 flex items-center justify-center">
                                    <i class="fa-solid fa-triangle-exclamation"></i>
                                </div>
                            </div>
                            <h3 id="stat-critical" class="text-3xl font-bold text-gray-900">0</h3>
                            <span id="critical-subtitle" class="text-sm font-medium text-red-600 mb-1">Requires
                                Action</span>
                        </div>
                        <div class="glass-card p-5 relative overflow-hidden">
                            <div class="flex justify-between items-start mb-4">
                                <p class="text-sm font-semibold text-gray-500">Avg Response Time</p>
                                <div
                                    class="w-8 h-8 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center">
                                    <i class="fa-regular fa-clock"></i>
                                </div>
                            </div>
                            <h3 class="text-3xl font-bold text-gray-900">1.2<span
                                    class="text-lg text-gray-400 font-normal">
                                    hrs</span></h3>
                        </div>
                    </div>
                </div>

                <div id="tab-reports" class="tab-pane hidden">
                    <!-- 2Ô∏è‚É£ ANALYTICS ROW 1 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <div
                            class="glass-card p-6 lg:col-span-1 bg-gradient-to-br from-indigo-900 to-brand-900 text-white shadow-lg relative overflow-hidden flex flex-col justify-between border-none">
                            <div
                                class="absolute -top-24 -right-24 w-48 h-48 bg-brand-500 rounded-full blur-3xl opacity-50">
                            </div>
                            <div>
                                <div class="flex items-center gap-2 mb-4">
                                    <i class="fa-solid fa-wand-magic-sparkles text-brand-300"></i>
                                    <h3 class="font-bold text-sm uppercase tracking-wider text-brand-100">AI Insights
                                    </h3>
                                </div>
                                <p class="text-lg font-medium leading-snug mb-4">"Service complaints increased by 18%
                                    this
                                    month, primarily mentioning 'slow seating' on weekends."</p>
                            </div>
                            <div class="space-y-3">
                                <div class="bg-black/20 backdrop-blur-md rounded-lg p-3 border border-white/10">
                                    <div class="flex justify-between text-xs text-brand-100 mb-1"><span>Targeted
                                            Metric</span><span>Impact</span></div>
                                    <div class="flex justify-between font-semibold"><span>Service Speed</span><span
                                            class="text-red-300">-4.2% Rating</span></div>
                                </div>
                            </div>
                        </div>
                        <div class="glass-card p-6 lg:col-span-2 flex flex-col">
                            <div class="flex justify-between items-center mb-4">
                                <div>
                                    <h3 class="font-bold text-gray-900">Sentiment Trend Over Time</h3>
                                    <p class="text-xs text-gray-500">30 Day timeline</p>
                                </div>
                            </div>
                            <div class="flex-1 relative w-full" style="min-height: 220px;">
                                <canvas id="sentimentTrendChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 2BÔ∏è‚É£ ANALYTICS ROW 2 -->
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                        <!-- Doughnut -->
                        <div class="glass-card p-6 flex flex-col items-center">
                            <div class="w-full flex justify-between items-center mb-6">
                                <h3 class="font-bold text-gray-900">Sentiment Breakdown</h3>
                            </div>
                            <div class="relative w-48 h-48">
                                <canvas id="sentimentDoughnut"></canvas>
                                <div
                                    class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                    <span id="doughnut-center" class="text-3xl font-bold text-gray-900">0%</span>
                                    <span class="text-xs text-gray-500 font-medium">Positive</span>
                                </div>
                            </div>
                            <div class="w-full mt-6 space-y-2">
                                <div class="flex justify-between items-center text-sm">
                                    <div class="flex items-center gap-2"><span
                                            class="w-3 h-3 rounded-full bg-emerald-500"></span><span
                                            class="font-medium text-gray-700">Positive</span></div><span
                                        id="doughnut-pos" class="font-bold">0</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <div class="flex items-center gap-2"><span
                                            class="w-3 h-3 rounded-full bg-amber-400"></span><span
                                            class="font-medium text-gray-700">Neutral</span></div><span
                                        id="doughnut-neu" class="font-bold">0</span>
                                </div>
                                <div class="flex justify-between items-center text-sm">
                                    <div class="flex items-center gap-2"><span
                                            class="w-3 h-3 rounded-full bg-red-500"></span><span
                                            class="font-medium text-gray-700">Negative</span></div><span
                                        id="doughnut-neg" class="font-bold">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-performance" class="tab-pane hidden">
                    <!-- Hardcoded Top Performing Table -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                        <div class="glass-card p-6 flex flex-col">
                            <div class="flex justify-between items-center mb-6">
                                <div>
                                    <h3 class="font-bold text-gray-900">Top Performing Branches üèÜ</h3>
                                    <p class="text-xs text-gray-500">Ranked by combined metrics formula</p>
                                </div>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left border-collapse">
                                    <thead>
                                        <tr
                                            class="text-xs text-gray-400 uppercase tracking-wider border-b border-gray-100">
                                            <th class="pb-3 font-semibold">Rank & Branch</th>
                                            <th class="pb-3 font-semibold text-center">Avg Rating</th>
                                            <th class="pb-3 font-semibold text-center">Positive %</th>
                                            <th class="pb-3 font-semibold text-right">Performance Score</th>
                                        </tr>
                                    </thead>
                                    <tbody id="performanceTableBody" class="text-sm">
                                        <!-- Injected by JS -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-inbox" class="tab-pane hidden">
                    <!-- 4Ô∏è‚É£ REVIEW MANAGEMENT TABLE -->
                    <div class="glass-card overflow-hidden mb-12">
                        <div
                            class="p-5 border-b border-gray-200 bg-white flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                            <div>
                                <h3 class="font-bold text-gray-900 text-lg">Recent Reviews Inbox</h3>
                                <p id="critical-subtitle-table"
                                    class="text-xs text-gray-500 cursor-pointer text-brand-600 hover:underline">0
                                    Critical
                                    issues pending response</p>
                            </div>
                            <div class="flex items-center gap-2">
                                <!-- Filters -->
                                <div class="relative">
                                    <select id="filterStatus"
                                        class="appearance-none bg-white border border-gray-200 text-gray-600 text-xs font-medium rounded-lg pl-3 pr-7 py-2 focus:outline-none focus:border-brand-500 shadow-sm cursor-pointer hover:bg-gray-50">
                                        <option>Status: All</option>
                                        <option>Status: Critical</option>
                                        <option>Status: Normal</option>
                                    </select>
                                    <i
                                        class="fa-solid fa-chevron-down absolute right-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-[10px] pointer-events-none"></i>
                                </div>
                                <div class="relative">
                                    <select id="filterSentiment"
                                        class="appearance-none bg-white border border-gray-200 text-gray-600 text-xs font-medium rounded-lg pl-3 pr-7 py-2 focus:outline-none focus:border-brand-500 shadow-sm cursor-pointer hover:bg-gray-50">
                                        <option>Sentiment: All</option>
                                        <option>Sentiment: Positive</option>
                                        <option>Sentiment: Negative</option>
                                        <option>Sentiment: Neutral</option>
                                    </select>
                                    <i
                                        class="fa-solid fa-chevron-down absolute right-2.5 top-1/2 -translate-y-1/2 text-gray-400 text-[10px] pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Dynamic Table Content -->
                        <div class="overflow-x-auto relative">
                            <table class="w-full text-left bg-white">
                                <thead class="bg-gray-50 border-b border-gray-100">
                                    <tr class="text-xs font-semibold text-gray-500 uppercase tracking-wider">
                                        <th class="p-4 w-60">Customer & Rating</th>
                                        <th class="p-4">Review Preview</th>
                                        <th class="p-4 w-32">Branch & Staff</th>
                                        <th class="p-4 w-32">Status</th>
                                        <th class="p-4 w-28 text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="reviewsTableBody" class="divide-y divide-gray-100 text-sm">
                                    <!-- Injected by JS -->
                                </tbody>
                            </table>
                            <div id="emptyState"
                                class="hidden text-center py-12 w-full bg-white absolute top-12 left-0 h-full z-10">
                                <i class="fa-regular fa-folder-open text-4xl text-gray-400 mb-3"></i>
                                <h3 class="text-lg font-medium text-gray-900">No reviews found</h3>
                                <p class="text-sm text-gray-500 mt-1">Try adjusting your filters or selecting a
                                    different
                                    branch.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tab-staff" class="tab-pane hidden">
                    <div class="glass-card p-12 text-center text-gray-500 mt-6">
                        <i class="fa-solid fa-person-digging text-4xl mb-3 text-gray-300"></i>
                        <h3 class="text-xl font-medium text-gray-900 mb-1">Staff Analytics</h3>
                        <p class="text-sm">This module is currently under construction. Check back soon for employee
                            performance tracking.</p>
                    </div>
                </div>

            </div>
        </main>
    </div> <!-- End Workspace -->

    <!-- Reply Modal -->
    <div id="replyModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl shadow-xl w-full max-w-lg p-6 m-4 transform transition-all border border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900"><i class="fa-solid fa-reply text-brand-500 mr-2"></i>
                    Respond to Review</h3>
                <button type="button" id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition p-1"><i
                        class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="mb-5 p-4 bg-gray-50 rounded-xl border border-gray-100 shadow-inner">
                <p class="text-sm text-gray-700 italic font-medium leading-relaxed" id="modalReviewText">"Loading review
                    text..."</p>
            </div>
            <form id="replyForm">
                <input type="hidden" id="modalReviewId">
                <div class="mb-5">
                    <label for="replyMessage" class="block text-sm font-semibold text-gray-700 mb-2">Your AI-Assisted
                        Response</label>
                    <textarea id="replyMessage" rows="5"
                        class="w-full bg-white border border-gray-300 rounded-xl p-3 text-sm focus:ring-brand-500 focus:border-brand-500 shadow-sm"
                        placeholder="Type your response here or click 'Generate AI Response'..." required></textarea>
                </div>
                <div class="flex justify-end gap-3 mt-2">
                    <button type="button" id="cancelModalBtn"
                        class="px-5 py-2.5 bg-white border border-gray-300 rounded-xl text-sm font-semibold text-gray-700 hover:bg-gray-50 transition shadow-sm">Cancel</button>
                    <button type="submit" id="submitReplyBtn"
                        class="px-5 py-2.5 bg-brand-600 rounded-xl text-sm font-semibold text-white hover:bg-brand-700 transition flex items-center gap-2 shadow-sm">
                        <i class="fa-regular fa-paper-plane"></i> Send Reply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Restaurant Modal -->
    <div id="addRestaurantModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl shadow-xl w-full max-w-md p-6 m-4 transform transition-all border border-gray-200">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                    <i class="fa-brands fa-google text-blue-500"></i> Auto-Sync Location
                </h3>
                <button type="button" id="closeAddModalBtn" class="text-gray-400 hover:text-gray-600 transition p-1"><i
                        class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-6 leading-relaxed">Search for a business on Google Places to instantly
                link it and import live public reviews.</p>
            <form id="addRestaurantForm">
                <div class="mb-4">
                    <label for="searchName" class="block text-sm font-semibold text-gray-700 mb-1.5">Business / Location
                        Name</label>
                    <div class="relative">
                        <i class="fa-solid fa-store absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchName"
                            class="w-full bg-white border border-gray-300 rounded-xl pl-10 pr-3 py-2.5 text-sm focus:ring-brand-500 focus:border-brand-500 shadow-sm"
                            placeholder="e.g. Starbucks" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label for="searchLocation" class="block text-sm font-semibold text-gray-700 mb-1.5">City or
                        Neighborhood</label>
                    <div class="relative">
                        <i class="fa-solid fa-location-dot absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchLocation"
                            class="w-full bg-white border border-gray-300 rounded-xl pl-10 pr-3 py-2.5 text-sm focus:ring-brand-500 focus:border-brand-500 shadow-sm"
                            placeholder="e.g. Manhattan, NY" required>
                    </div>
                </div>
                <div id="addRestaurantError"
                    class="hidden mb-4 text-xs font-semibold text-red-600 bg-red-50 p-3 rounded-lg border border-red-200">
                    Failed to fetch.</div>
                <button type="submit" id="submitAddBtn"
                    class="w-full px-4 py-3 bg-brand-600 rounded-xl text-sm font-semibold text-white hover:bg-brand-700 transition flex justify-center items-center gap-2 shadow-sm">
                    <i class="fa-solid fa-magnifying-glass"></i> Search & Sync Target
                </button>
            </form>
        </div>
    </div>

    <!-- Review Row Template -->
    <template id="reviewRowTemplate">
        <tr class="hover:bg-gray-50 transition border-b border-gray-50 relative group z-0">
            <td class="p-4 align-top">
                <div class="flex items-center gap-3">
                    <div
                        class="source-icon-wrap w-8 h-8 rounded-lg bg-gray-100 flex items-center justify-center shrink-0 shadow-sm">
                        <i class="source-icon text-lg"></i>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-900 review-author tracking-tight">Author</p>
                        <div class="flex text-yellow-400 text-xs mt-0.5 rating-stars">
                            <!-- Stars injected here -->
                        </div>
                    </div>
                </div>
            </td>
            <td class="p-4 w-2/5 max-w-xs align-top">
                <p class="text-gray-700 font-medium text-sm line-clamp-3 review-text pr-4 leading-relaxed">""</p>
                <div class="mt-2 flex gap-1.5 flex-wrap review-tags">
                    <!-- Tags injected here -->
                </div>
            </td>
            <td class="p-4 align-top">
                <p class="font-semibold text-gray-900 text-xs branch-name truncate w-32">Branch</p>
                <p class="text-[10px] text-gray-500 mt-1 truncate w-32"><i
                        class="fa-solid fa-user-tag text-gray-400 mr-1"></i> <span class="staff-text font-medium">Not
                        Tagged</span></p>
            </td>
            <td class="p-4 align-top">
                <span
                    class="status-badge font-semibold px-2.5 py-1 text-[10px] rounded-lg border shadow-sm inline-block">Status</span>
            </td>
            <td class="p-4 text-right align-top">
                <button
                    class="reply-btn bg-white border border-gray-300 hover:bg-gray-50 hover:text-brand-600 text-gray-700 px-3 py-1.5 rounded-lg text-xs font-semibold shadow-sm transition inline-flex items-center gap-1.5 ml-auto">
                    <i class="fa-solid fa-reply"></i> Reply
                </button>
            </td>
        </tr>
    </template>

    <!-- DATABASE & INTERACTION LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, collection, getDoc, getDocs, query, orderBy, addDoc, updateDoc, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // Tab Navigation Logic
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all tabs
                document.querySelectorAll('.tab-btn').forEach(b => {
                    b.classList.remove('active', 'bg-gray-50');
                    b.classList.add('text-gray-600');
                });
                // Hide all panes
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('block');
                    pane.classList.add('hidden');
                });

                // Set clicked active
                btn.classList.add('active', 'bg-gray-50');
                btn.classList.remove('text-gray-600');

                // Show target pane
                const targetId = btn.getAttribute('data-target');
                document.getElementById(targetId).classList.remove('hidden');
                document.getElementById(targetId).classList.add('block');
            });
        });

        // Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBthIwz58nk23yTy8ntgN0T0ATqKUSHZbU",
            authDomain: "hackx26.firebaseapp.com",
            projectId: "hackx26",
            storageBucket: "hackx26.firebasestorage.app",
            messagingSenderId: "569116765255",
            appId: "1:569116765255:web:d7b86db5f99f01a29bd562"
        };
        const GOOGLE_PLACES_API_KEY = "AIzaSyDDHmxiUoDtQoAQAhpcB8Tkzxz1zW-PtX8";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let allReviews = [];
        let branchMap = {};
        let staffMap = {};
        let sentimentChart = null;
        let trendChart = null;

        // AUTHENTICATION
        onAuthStateChanged(auth, async (user) => {
            if (user) await handleSuccessfulLogin(user);
            else showLoginScreen();
        });

        document.getElementById('googleSignInBtn').addEventListener('click', () => {
            const btn = document.getElementById('googleSignInBtn');
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Signing in...';
            signInWithPopup(auth, provider).catch(err => {
                document.getElementById('loginError').textContent = err.message;
                document.getElementById('loginError').classList.remove('hidden');
                btn.innerHTML = '<img src="https://upload.wikimedia.org/wikipedia/commons/c/c1/Google_%22G%22_logo.svg" alt="Google Logo" class="w-5 h-5"> Sign in with Google';
            });
        });

        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));

        function showLoginScreen() {
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('loginOverlay').classList.remove('opacity-0');
            document.getElementById('appWorkspace').classList.add('hidden');
            document.getElementById('appWorkspace').classList.remove('opacity-100');
        }

        async function handleSuccessfulLogin(firebaseUser) {
            try {
                const userDoc = await getDoc(doc(db, "users", firebaseUser.uid));
                if (userDoc.exists() && userDoc.data().isActive) currentUser = { uid: firebaseUser.uid, ...userDoc.data() };
                else {
                    currentUser = { uid: firebaseUser.uid, name: firebaseUser.displayName || "Demo", email: firebaseUser.email, role: "admin", isActive: true };
                    await setDoc(doc(db, "users", firebaseUser.uid), currentUser, { merge: true });
                }

                document.getElementById('userNameDisplay').textContent = currentUser.name;
                document.getElementById('userRoleDisplay').textContent = currentUser.role.replace('_', ' ') + " ‚Ä¢ Access granted";
                document.getElementById('userAvatar').src = firebaseUser.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(currentUser.name)}&background=1d4ed8&color=fff`;

                if (currentUser.role === 'admin') document.getElementById('openAddRestaurantBtn').classList.remove('hidden');

                document.getElementById('loginOverlay').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('loginOverlay').classList.add('hidden');
                    const ws = document.getElementById('appWorkspace');
                    ws.classList.remove('hidden');
                    setTimeout(() => ws.classList.add('opacity-100'), 50);
                }, 300);

                initDataFetch();
            } catch (e) { signOut(auth); }
        }

        // FETCH DATA
        async function initDataFetch() {
            await Promise.all([fetchBranches(), fetchStaff()]);
            await fetchReviews();
            setupFilters();
        }

        async function fetchBranches() {
            const snap = await getDocs(collection(db, "branches"));
            const sel = document.getElementById('branchSelector');
            sel.innerHTML = '<option value="all">üè¢ All Branches Overview</option>';
            snap.forEach(doc => {
                branchMap[doc.id] = doc.data().name;
                if (currentUser.role === 'admin' || currentUser.branchId === doc.id) {
                    sel.innerHTML += `<option value="${doc.id}">üìç ${doc.data().name}</option>`;
                }
            });
            if (currentUser.role === 'branch_manager' && currentUser.branchId) {
                sel.value = currentUser.branchId;
                sel.querySelector('option[value="all"]').disabled = true;
            }
        }

        async function fetchStaff() {
            const snap = await getDocs(collection(db, "staff"));
            snap.forEach(doc => staffMap[doc.id] = doc.data().name);
        }

        async function fetchReviews() {
            const snap = await getDocs(query(collection(db, "reviews"), orderBy("createdAt", "desc")));
            allReviews = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderDashboard();
        }

        // RENDER LOGIC
        function setupFilters() {
            document.getElementById('branchSelector').addEventListener('change', renderDashboard);
            document.getElementById('filterStatus').addEventListener('change', renderDashboard);
            document.getElementById('filterSentiment').addEventListener('change', renderDashboard);
            document.getElementById('globalSearchInput').addEventListener('keyup', renderDashboard);
        }

        function renderDashboard() {
            const branch = document.getElementById('branchSelector').value;
            const statusFull = document.getElementById('filterStatus').value || "all";
            const status = statusFull.includes(': ') ? statusFull.split(': ').pop().toLowerCase() : "all";

            const sentimentFull = document.getElementById('filterSentiment').value || "all";
            const sentiment = sentimentFull.includes(': ') ? sentimentFull.split(': ').pop().toLowerCase() : "all";

            const query = document.getElementById('globalSearchInput').value.toLowerCase().trim();

            let filtered = allReviews.filter(r => {
                if (currentUser.role === 'branch_manager' && r.branchId !== currentUser.branchId) return false;
                if (branch !== 'all' && r.branchId !== branch) return false;
                if (status !== 'all' && status !== r.status) return false;
                if (sentiment !== 'all' && sentiment !== r.sentiment) return false;

                if (query) {
                    const matchText = (r.reviewText || '').toLowerCase().includes(query);
                    const matchAuthor = (r.authorName || '').toLowerCase().includes(query);
                    const matchBranch = (branchMap[r.branchId] || '').toLowerCase().includes(query);
                    const matchStaff = (r.staffTagged || '').toLowerCase().includes(query);
                    if (!matchText && !matchAuthor && !matchBranch && !matchStaff) return false;
                }

                return true;
            });

            updateKPIs(filtered);
            renderTable(filtered);
            updatePerformanceTable(filtered);
            updateCharts(filtered, allReviews);
        }

        function updateKPIs(data) {
            const tot = data.length;
            const crit = data.filter(r => r.status === 'critical').length;
            const avg = tot ? (data.reduce((acc, r) => acc + r.rating, 0) / tot).toFixed(1) : "0.0";
            const sentScore = tot ? Math.round((data.filter(r => r.sentiment === 'positive').length / tot) * 100) : 0;

            document.getElementById('stat-total').textContent = tot.toLocaleString();
            document.getElementById('stat-avg').textContent = avg;
            document.getElementById('stat-critical').textContent = crit;
            document.getElementById('stat-sentiment').textContent = sentScore;

            const bar = document.getElementById('stat-sentiment-bar');
            bar.style.width = sentScore + '%';
            bar.className = `absolute bottom-0 left-0 h-1 rounded-b-xl transition-all duration-1000 ${sentScore >= 70 ? 'bg-emerald-500' : sentScore >= 40 ? 'bg-amber-500' : 'bg-red-500'}`;

            document.getElementById('critical-subtitle').textContent = `${crit} Critical issues pending response`;
            document.getElementById('critical-subtitle-table').textContent = `${crit} Critical issues pending response`;

            // Sidebar unread badge
            const sidebarCount = document.getElementById('sidebar-critical-count');
            sidebarCount.textContent = crit;
            if (crit > 0) {
                sidebarCount.classList.remove('hidden');
            } else {
                sidebarCount.classList.add('hidden');
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('reviewsTableBody');
            const template = document.getElementById('reviewRowTemplate');
            const empty = document.getElementById('emptyState');
            tbody.innerHTML = '';

            if (!data.length) { empty.classList.remove('hidden'); return; }
            empty.classList.add('hidden');

            data.forEach(r => {
                const row = template.content.cloneNode(true);
                row.querySelector('.review-author').textContent = r.authorName || 'Google User';
                row.querySelector('.review-text').textContent = `"${r.reviewText}"`;
                row.querySelector('.branch-name').textContent = branchMap[r.branchId] || 'Unknown';
                row.querySelector('.staff-text').textContent = r.staffTagged ? (staffMap[r.staffTagged] || r.staffTagged) : 'Not Tagged';

                // Source Icon
                const icon = row.querySelector('.source-icon');
                if (r.source === 'google') icon.className = 'fa-brands fa-google text-blue-500';
                else icon.className = 'fa-solid fa-utensils text-brand-500';

                // Stars
                const stars = row.querySelector('.rating-stars');
                for (let i = 1; i <= 5; i++) stars.innerHTML += i <= r.rating ? '<i class="fa-solid fa-star"></i>' : '<i class="fa-regular fa-star text-gray-300"></i>';

                // Status Badge & Action
                const badge = row.querySelector('.status-badge');
                if (r.responseStatus === 'responded') {
                    // Responded takes priority for badge
                    badge.textContent = 'RESPONDED';
                    badge.className = 'font-semibold px-2.5 py-1 text-[10px] rounded-lg shadow-sm bg-blue-50 text-blue-700 border border-blue-200';
                    row.querySelector('.reply-btn').outerHTML = `<span class="text-xs font-semibold text-gray-500 flex items-center gap-1.5 ml-auto bg-gray-50 px-3 py-1.5 rounded-lg border border-gray-100"><i class="fa-solid fa-check"></i> Replied</span>`;
                } else if (r.status === 'critical') {
                    badge.textContent = 'CRITICAL';
                    badge.className = 'font-semibold px-2.5 py-1 text-[10px] rounded-lg shadow-sm bg-red-50 text-red-700 border border-red-200';
                    row.querySelector('.reply-btn').addEventListener('click', () => openReplyModal(r));
                } else {
                    badge.textContent = 'PENDING';
                    badge.className = 'font-semibold px-2.5 py-1 text-[10px] rounded-lg shadow-sm bg-gray-50 text-gray-600 border border-gray-200';
                    row.querySelector('.reply-btn').addEventListener('click', () => openReplyModal(r));
                }

                // Sentiment & Category Tags
                if (r.category && r.category !== 'pending') {
                    const tagClass = r.sentiment === 'positive' ? 'bg-emerald-50 text-emerald-700 border-emerald-200' : r.sentiment === 'negative' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-amber-50 text-amber-700 border-amber-200';
                    row.querySelector('.review-tags').innerHTML = `<span class="text-[10px] px-2 py-0.5 rounded border ${tagClass} font-semibold shadow-sm">${r.category}</span>`;
                } else {
                    // Just show sentiment if category is pending
                    let tClass = 'bg-gray-50 text-gray-600 border-gray-200';
                    if (r.sentiment === 'positive') tClass = 'bg-emerald-50 text-emerald-700 border-emerald-200';
                    if (r.sentiment === 'negative') tClass = 'bg-red-50 text-red-700 border-red-200';
                    row.querySelector('.review-tags').innerHTML = `<span class="text-[10px] px-2 py-0.5 rounded border ${tClass} font-semibold shadow-sm">${r.sentiment.toUpperCase()}</span>`;
                }

                tbody.appendChild(row);
            });
        }

        function updatePerformanceTable(data) {
            const tbody = document.getElementById('performanceTableBody');
            if (!tbody) return;
            tbody.innerHTML = '';

            // Calculate stats per branch
            const branchStats = {};
            Object.keys(branchMap).forEach(bId => {
                branchStats[bId] = { id: bId, name: branchMap[bId], reviews: 0, ratingSum: 0, positiveCount: 0 };
            });

            data.forEach(r => {
                if (branchStats[r.branchId]) {
                    branchStats[r.branchId].reviews++;
                    branchStats[r.branchId].ratingSum += r.rating;
                    if (r.sentiment === 'positive') branchStats[r.branchId].positiveCount++;
                }
            });

            // Calculate scores
            const ranked = Object.values(branchStats).filter(b => b.reviews > 0).map(b => {
                const avgRating = b.ratingSum / b.reviews;
                const positivePct = Math.round((b.positiveCount / b.reviews) * 100);
                // Weighted score: max 100. (Rating max 5 = 60 points, Positive max 100% = 40 points)
                const score = ((avgRating / 5) * 60) + ((positivePct / 100) * 40);
                return { ...b, avgRating: avgRating.toFixed(1), positivePct, score: score.toFixed(1) };
            });

            // Sort by score descending
            ranked.sort((a, b) => b.score - a.score);

            if (ranked.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">No data available for selected filters.</td></tr>';
                return;
            }

            ranked.forEach((b, index) => {
                const rankColors = index === 0 ? 'bg-yellow-100 text-yellow-600' : index === 1 ? 'bg-gray-200 text-gray-600' : index === 2 ? 'bg-orange-100 text-orange-600' : 'bg-gray-100 text-gray-500';

                tbody.innerHTML += `
                    <tr class="border-b border-gray-50 hover:bg-gray-50 transition">
                        <td class="py-4 flex items-center gap-3">
                            <div class="w-6 h-6 rounded-full ${rankColors} flex items-center justify-center font-bold text-xs">${index + 1}</div>
                            <div class="font-semibold text-gray-900">${b.name}</div>
                        </td>
                        <td class="py-4 text-center font-medium">${b.avgRating} <i class="fa-solid fa-star text-yellow-400 text-xs text-center"></i></td>
                        <td class="py-4 text-center">
                            <div class="flex items-center gap-2 justify-center">
                                <span class="text-emerald-600 font-medium">${b.positivePct}%</span>
                                <div class="w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="bg-emerald-500 h-full" style="width: ${b.positivePct}%"></div>
                                </div>
                            </div>
                        </td>
                        <td class="py-4 text-right">
                            <span class="bg-emerald-50 text-emerald-700 font-bold px-2.5 py-1 rounded-lg border border-emerald-100">${b.score}</span>
                        </td>
                    </tr>
                `;
            });
        }

        // CHARTS LOGIC
        function updateCharts(data, all) {
            const p = data.filter(r => r.sentiment === 'positive').length;
            const u = data.filter(r => r.sentiment === 'neutral' || r.sentiment === 'pending').length;
            const n = data.filter(r => r.sentiment === 'negative').length;
            const t = p + u + n;

            document.getElementById('doughnut-pos').textContent = p;
            document.getElementById('doughnut-neu').textContent = u;
            document.getElementById('doughnut-neg').textContent = n;
            document.getElementById('doughnut-center').textContent = t ? Math.round((p / t) * 100) + '%' : '0%';

            if (!sentimentChart) {
                sentimentChart = new Chart(document.getElementById('sentimentDoughnut').getContext('2d'), {
                    type: 'doughnut',
                    data: { labels: ['Pos', 'Neu', 'Neg'], datasets: [{ data: [p, u, n], backgroundColor: ['#10B981', '#FBBF24', '#EF4444'], borderWidth: 0, hoverOffset: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { display: false } } }
                });
            } else {
                sentimentChart.data.datasets[0].data = [p, u, n];
                sentimentChart.update();
            }

            if (!trendChart) {
                trendChart = new Chart(document.getElementById('sentimentTrendChart').getContext('2d'), {
                    type: 'line',
                    data: {
                        labels: ['7d', '6d', '5d', '4d', '3d', '2d', 'Today'],
                        datasets: [{ label: 'Incoming volume', data: [15, 29, 30, 21, 16, 25, 40], borderColor: '#3b82f6', backgroundColor: '#3b82f620', fill: true, tension: 0.4, borderWidth: 2 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' }, border: { display: false } }, x: { grid: { display: false }, border: { display: false } } }
                    }
                });
            }
        }

        // REPLY MODAL LOGIC
        function openReplyModal(r) {
            document.getElementById('modalReviewId').value = r.id;
            document.getElementById('modalReviewText').textContent = `"${r.reviewText}"`;
            document.getElementById('replyMessage').value = '';
            document.getElementById('replyModal').classList.remove('hidden');
        }
        function closeReplyModal() { document.getElementById('replyModal').classList.add('hidden'); }
        document.getElementById('closeModalBtn').onclick = closeReplyModal;
        document.getElementById('cancelModalBtn').onclick = closeReplyModal;

        document.getElementById('replyForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitReplyBtn');
            const og = btn.innerHTML;
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

            try {
                const id = document.getElementById('modalReviewId').value;
                await setDoc(doc(collection(db, "responses")), {
                    reviewId: id, responseText: document.getElementById('replyMessage').value, respondedBy: currentUser.uid, respondedAt: serverTimestamp()
                });
                await updateDoc(doc(db, "reviews", id), { responseStatus: "responded" });
                allReviews.find(r => r.id === id).responseStatus = 'responded';
                renderDashboard();
                closeReplyModal();
            } catch (e) { alert("Error saving response: " + e.message); }
            btn.disabled = false; btn.innerHTML = og;
        };

        // ADD RESTAURANT MODAL (GOOGLE PROXY FETCH)
        const addMod = document.getElementById('addRestaurantModal');
        document.getElementById('openAddRestaurantBtn').onclick = () => { addMod.classList.remove('hidden'); document.getElementById('addRestaurantError').classList.add('hidden'); };
        document.getElementById('closeAddModalBtn').onclick = () => addMod.classList.add('hidden');

        document.getElementById('addRestaurantForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitAddBtn');
            const err = document.getElementById('addRestaurantError');
            const og = btn.innerHTML;

            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Proxying Google API...';
            err.classList.add('hidden');

            try {
                const bName = document.getElementById('searchName').value.trim();
                const bLoc = document.getElementById('searchLocation').value.trim();
                const query = encodeURIComponent(`${bName} ${bLoc}`);

                const searchRes = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://maps.googleapis.com/maps/api/place/textsearch/json?query=${query}&key=${GOOGLE_PLACES_API_KEY}`)}`);
                const searchData = await searchRes.json();
                if (!searchData.results?.length) throw new Error("No business found matching this criteria on Google.");
                const placeId = searchData.results[0].place_id;

                const detRes = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(`https://maps.googleapis.com/maps/api/place/details/json?place_id=${placeId}&fields=name,formatted_address,rating,user_ratings_total,reviews&reviews_sort=newest&key=${GOOGLE_PLACES_API_KEY}`)}`);
                const detData = await detRes.json();
                const details = detData.result;

                const branchRef = await addDoc(collection(db, "branches"), {
                    name: details.name, location: bLoc, managerId: currentUser.uid, placeId: placeId, status: "active",
                    totalReviews: details.user_ratings_total || 0, averageRating: details.rating || 0, createdAt: serverTimestamp()
                });

                if (details.reviews && details.reviews.length > 0) {
                    for (const r of details.reviews) {
                        await addDoc(collection(db, "reviews"), {
                            branchId: branchRef.id, source: "google", externalReviewId: `${r.author_name}_${r.time * 1000}`,
                            authorName: r.author_name, rating: r.rating, reviewText: r.text || "No text provided.",
                            sentiment: r.rating > 3 ? 'positive' : r.rating === 3 ? 'neutral' : 'negative',
                            status: r.rating <= 2 ? "critical" : "normal", responseStatus: "pending",
                            externalTimestamp: r.time * 1000, syncedAt: serverTimestamp(), createdAt: serverTimestamp()
                        });
                    }
                }

                await initDataFetch();
                document.getElementById('branchSelector').value = branchRef.id;
                renderDashboard();
                addMod.classList.add('hidden');
            } catch (e) { err.textContent = e.message; err.classList.remove('hidden'); }

            btn.disabled = false; btn.innerHTML = og;
        };
    </script>
</body>

</html>