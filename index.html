<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Review Management Dashboard</title>
    <!-- Tailwind CSS (via CDN for hackathon speed) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .critical-badge {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .positive-badge {
            background-color: #dcfce7;
            color: #166534;
        }

        .neutral-badge {
            background-color: #f3f4f6;
            color: #4b5563;
        }

        .sentiment-score-bar-high {
            background-color: #22c55e;
        }

        .sentiment-score-bar-med {
            background-color: #eab308;
        }

        .sentiment-score-bar-low {
            background-color: #ef4444;
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden">

    <!-- Top Navigation -->
    <nav class="bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-3">
            <div class="bg-blue-600 text-white p-2 rounded-lg">
                <i class="fa-solid fa-star-half-stroke text-xl"></i>
            </div>
            <h1 class="text-xl font-bold text-gray-800">ReviewIQ Dashboard</h1>
        </div>
        <div class="flex items-center gap-4">
            <select id="branchSelector"
                class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                <option value="all">All Branches</option>
                <!-- Branches populated dynamically -->
            </select>
            <div class="flex items-center gap-2 border-l border-gray-200 pl-4">
                <img src="https://ui-avatars.com/api/?name=Admin+User&background=0D8ABC&color=fff"
                    class="w-8 h-8 rounded-full" alt="User">
                <span class="text-sm font-medium">Admin User</span>
            </div>
        </div>
    </nav>

    <!-- Main Content Layout -->
    <div class="flex flex-1 overflow-hidden">

        <!-- Left Sidebar: Analytics & Filters -->
        <aside class="w-80 bg-white border-r border-gray-200 p-6 overflow-y-auto hidden md:block z-0">
            <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Overview Metrics</h2>

            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <p class="text-3xl font-bold text-blue-700" id="stat-total">0</p>
                    <p class="text-xs text-blue-600 font-medium mt-1">Total Reviews</p>
                </div>
                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                    <p class="text-3xl font-bold text-green-700" id="stat-avg">0.0</p>
                    <p class="text-xs text-green-600 font-medium mt-1">Avg Rating</p>
                </div>
                <div class="bg-red-50 p-4 rounded-xl border border-red-100 col-span-2">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="text-3xl font-bold text-red-700" id="stat-critical">0</p>
                            <p class="text-xs text-red-600 font-medium mt-1">Critical Alerts</p>
                        </div>
                        <i class="fa-solid fa-triangle-exclamation text-2xl text-red-400"></i>
                    </div>
                </div>
            </div>

            <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Sentiment Breakdown</h2>
            <div class="mb-8 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                <canvas id="sentimentChart" width="100%" height="200"></canvas>
            </div>

            <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Filters</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Status</label>
                    <select id="filterStatus"
                        class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All Statuses</option>
                        <option value="critical">Critical Only</option>
                        <option value="normal">Normal</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-700 mb-1">Sentiment</label>
                    <select id="filterSentiment"
                        class="w-full bg-gray-50 border border-gray-300 rounded-lg p-2 text-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="all">All Sentiments</option>
                        <option value="positive">Positive</option>
                        <option value="neutral">Neutral</option>
                        <option value="negative">Negative</option>
                    </select>
                </div>
            </div>

            <div class="mt-8">
                <button id="refreshBtn"
                    class="w-full bg-white border border-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-50 transition flex items-center justify-center gap-2">
                    <i class="fa-solid fa-rotate-right"></i> Refresh Data
                </button>
            </div>
        </aside>

        <!-- Main Workspace: Review List -->
        <main class="flex-1 overflow-y-auto p-8">
            <div class="flex justify-between items-end mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Recent Reviews</h2>
                    <p class="text-sm text-gray-500 mt-1">Manage and respond to customer feedback across all branches.
                    </p>
                </div>
            </div>

            <div id="loadingIndicator" class="text-center py-12">
                <i class="fa-solid fa-spinner fa-spin text-4xl text-blue-500"></i>
                <p class="mt-4 text-gray-500">Loading reviews...</p>
            </div>

            <!-- Reviews Container -->
            <div id="reviewsContainer" class="space-y-4 hidden">
                <!-- Review cards will be injected here -->
            </div>

            <div id="emptyState"
                class="hidden text-center py-16 bg-white rounded-xl border border-dashed border-gray-300">
                <i class="fa-regular fa-folder-open text-4xl text-gray-400 mb-3"></i>
                <h3 class="text-lg font-medium text-gray-900">No reviews found</h3>
                <p class="text-sm text-gray-500 mt-1">Try adjusting your filters or selecting a different branch.</p>
            </div>
        </main>
    </div>

    <!-- Reply Modal (Hidden by default) -->
    <div id="replyModal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 m-4 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-900">Respond to Review</h3>
                <button type="button" id="closeModalBtn" class="text-gray-400 hover:text-gray-600 transition">
                    <i class="fa-solid fa-xmark text-xl"></i>
                </button>
            </div>

            <div class="mb-4 p-3 bg-gray-50 rounded-lg border border-gray-100">
                <p class="text-sm text-gray-600 italic" id="modalReviewText">"Loading review text..."</p>
            </div>

            <form id="replyForm">
                <input type="hidden" id="modalReviewId">
                <div class="mb-4">
                    <label for="replyMessage" class="block text-sm font-medium text-gray-700 mb-2">Your Response</label>
                    <textarea id="replyMessage" rows="4"
                        class="w-full bg-white border border-gray-300 rounded-lg p-3 text-sm focus:ring-blue-500 focus:border-blue-500"
                        placeholder="Type your response here..." required></textarea>
                </div>

                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancelModalBtn"
                        class="px-4 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-50 transition">Cancel</button>
                    <button type="submit" id="submitReplyBtn"
                        class="px-4 py-2 bg-blue-600 rounded-lg text-sm font-medium text-white hover:bg-blue-700 transition flex items-center gap-2">
                        <i class="fa-regular fa-paper-plane"></i> Send Reply
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Template for a Review Card (Hidden) -->
    <template id="reviewCardTemplate">
        <div class="glass-panel rounded-xl border border-gray-200 p-5 shadow-sm hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center gap-3">
                    <div class="source-icon text-xl"></div>
                    <div>
                        <div class="flex items-center gap-2">
                            <span class="font-semibold text-gray-900 branch-name">Branch Name</span>
                            <span class="text-xs px-2 py-0.5 rounded-full status-badge font-medium">Status</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-0.5 review-date">Date</p>
                    </div>
                </div>
                <div class="flex text-yellow-400 text-sm rating-stars">
                    <!-- Stars injected here -->
                </div>
            </div>

            <p class="text-gray-800 text-sm mb-4 leading-relaxed review-text">Review Content</p>

            <div class="flex flex-wrap items-center gap-4 text-xs">
                <!-- Data Points -->
                <div
                    class="flex items-center gap-1.5 text-gray-600 bg-gray-50 px-2.5 py-1.5 rounded-md border border-gray-100">
                    <i class="fa-solid fa-tags text-gray-400"></i>
                    <span class="category-text">Category</span>
                </div>

                <div
                    class="flex items-center gap-1.5 text-gray-600 bg-gray-50 px-2.5 py-1.5 rounded-md border border-gray-100">
                    <i class="fa-solid fa-user-tag text-gray-400"></i>
                    <span class="staff-text">Staff</span>
                </div>

                <!-- Sentiment Score Bar -->
                <div class="flex items-center gap-2 ml-auto">
                    <span class="text-gray-500 font-medium">AI Sentiment</span>
                    <div class="w-16 h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div class="h-full sentiment-bar w-0 transition-all duration-1000"></div>
                    </div>
                    <span class="font-semibold sentiment-score-text mt-px w-8 text-right">0%</span>
                </div>
            </div>

            <!-- Action Area / Response Status -->
            <div class="mt-4 pt-4 border-t border-gray-100 flex justify-between items-center action-area">
                <div class="response-status-badge text-xs font-medium px-2.5 py-1 rounded bg-gray-100 text-gray-600">
                    <i class="fa-regular fa-clock mr-1"></i> Pending Response
                </div>
                <button
                    class="reply-btn text-sm font-medium text-blue-600 hover:text-blue-800 transition flex items-center gap-1.5 px-3 py-1.5 rounded-lg hover:bg-blue-50">
                    <i class="fa-solid fa-reply"></i> Reply
                </button>
            </div>
        </div>
    </template>

    <!-- Firebase SDK Setup -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getFirestore, collection, getDocs, query, orderBy, addDoc, updateDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // =========================================================================
        // USING THE SAME CONFIG FROM SEED.HTML
        // =========================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBthIwz58nk23yTy8ntgN0T0ATqKUSHZbU",
            authDomain: "hackx26.firebaseapp.com",
            projectId: "hackx26",
            storageBucket: "hackx26.firebasestorage.app",
            messagingSenderId: "569116765255",
            appId: "1:569116765255:web:d7b86db5f99f01a29bd562"
        };
        // =========================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Core Global State
        let allReviews = [];
        let branchMap = {}; // Maps branchId to Branch Name
        let staffMap = {};  // Maps staffId to Staff Name
        let sentimentChart = null; // Chart instance

        // Initialization
        async function init() {
            try {
                await Promise.all([
                    fetchBranches(),
                    fetchStaff()
                ]);
                await fetchReviews();
                setupEventListeners();
            } catch (error) {
                console.error("Error initializing dashboard:", error);
                document.getElementById('loadingIndicator').innerHTML = `
                    <i class="fa-solid fa-circle-exclamation text-4xl text-red-500 border-red-500"></i>
                    <p class="mt-4 text-red-600 font-medium">Failed to load data. Check console.</p>
                `;
            }
        }

        // 1. Fetch Lookups
        async function fetchBranches() {
            const branchesSnapshot = await getDocs(collection(db, "branches"));
            const selector = document.getElementById('branchSelector');

            branchesSnapshot.forEach(doc => {
                const data = doc.data();
                branchMap[doc.id] = data.name;

                const option = document.createElement('option');
                option.value = doc.id;
                option.textContent = data.name;
                selector.appendChild(option);
            });
        }

        async function fetchStaff() {
            const staffSnapshot = await getDocs(collection(db, "staff"));
            staffSnapshot.forEach(doc => {
                const data = doc.data();
                staffMap[doc.id] = data.name;
            });
        }

        // 2. Fetch Core Data
        async function fetchReviews() {
            showLoading(true);

            // Note: In an MVP, we fetch everything and filter client-side for speed
            // In Production, use `query(collection(db, "reviews"), where(...))`
            const q = query(collection(db, "reviews"), orderBy("createdAt", "desc"));
            const reviewSnapshot = await getDocs(q);

            allReviews = reviewSnapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));

            renderDashboard();
            showLoading(false);
        }

        // 3. Rendering Logic
        function renderDashboard() {
            const selectedBranch = document.getElementById('branchSelector').value;
            const selectedStatus = document.getElementById('filterStatus').value;
            const selectedSentiment = document.getElementById('filterSentiment').value;

            // Apply Filters Client-Side
            let filteredReviews = allReviews.filter(review => {
                if (selectedBranch !== 'all' && review.branchId !== selectedBranch) return false;
                if (selectedStatus !== 'all' && review.status !== selectedStatus) return false;
                if (selectedSentiment !== 'all' && review.sentiment !== selectedSentiment) return false;
                return true;
            });

            updateMetrics(filteredReviews);
            renderReviewCards(filteredReviews);
        }

        function updateMetrics(reviews) {
            const total = reviews.length;
            const critical = reviews.filter(r => r.status === 'critical').length;

            const avgRating = total > 0
                ? (reviews.reduce((sum, r) => sum + r.rating, 0) / total).toFixed(1)
                : "0.0";

            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-avg').textContent = avgRating;
            document.getElementById('stat-critical').textContent = critical;

            updateChart(reviews);
        }

        // Initialize Chart
        function initChart() {
            const ctx = document.getElementById('sentimentChart').getContext('2d');
            sentimentChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Positive', 'Neutral', 'Negative'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: [
                            '#22c55e', // Green
                            '#eab308', // Yellow
                            '#ef4444'  // Red
                        ],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '75%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    family: "'Inter', sans-serif",
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update Chart Data
        function updateChart(reviews) {
            if (!sentimentChart) initChart();

            const posCount = reviews.filter(r => r.sentiment === 'positive').length;
            const neuCount = reviews.filter(r => r.sentiment === 'neutral').length;
            const negCount = reviews.filter(r => r.sentiment === 'negative').length;

            sentimentChart.data.datasets[0].data = [posCount, neuCount, negCount];
            sentimentChart.update();
        }

        function renderReviewCards(reviews) {
            const container = document.getElementById('reviewsContainer');
            const template = document.getElementById('reviewCardTemplate');
            const emptyState = document.getElementById('emptyState');

            container.innerHTML = '';

            if (reviews.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');

            reviews.forEach(review => {
                const clone = template.content.cloneNode(true);

                // Content Mapping
                clone.querySelector('.review-text').textContent = review.reviewText;
                clone.querySelector('.branch-name').textContent = branchMap[review.branchId] || 'Unknown Branch';

                // Date formatting
                const d = review.createdAt ? review.createdAt.toDate() : new Date();
                clone.querySelector('.review-date').textContent = d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

                // Source Icon
                const icon = clone.querySelector('.source-icon');
                if (review.source === 'google') icon.innerHTML = '<i class="fa-brands fa-google text-red-500"></i>';
                else if (review.source === 'zomato') icon.innerHTML = '<i class="fa-solid fa-utensils text-red-600"></i>';
                else icon.innerHTML = '<i class="fa-solid fa-laptop-code text-blue-500"></i>';

                // Badges
                const badge = clone.querySelector('.status-badge');
                badge.textContent = review.status.toUpperCase();
                badge.className = `text-[10px] px-2 py-0.5 rounded border font-semibold ${review.status === 'critical' ? 'bg-red-50 text-red-700 border-red-200' :
                    review.status === 'escalated' ? 'bg-orange-50 text-orange-700 border-orange-200' :
                        'bg-green-50 text-green-700 border-green-200'
                    }`;

                // Tags & Details
                clone.querySelector('.category-text').textContent = review.category || "Uncategorized";
                clone.querySelector('.staff-text').textContent = review.staffTagged ? (staffMap[review.staffTagged] || review.staffTagged) : "No Staff Tagged";

                // Rating Stars
                const starsContainer = clone.querySelector('.rating-stars');
                let starsHTML = '';
                for (let i = 1; i <= 5; i++) {
                    starsHTML += i <= review.rating
                        ? '<i class="fa-solid fa-star"></i>'
                        : '<i class="fa-regular fa-star text-gray-300"></i>';
                }
                starsContainer.innerHTML = starsHTML;

                // Sentiment Score
                const score = Math.round((review.sentimentScore || 0) * 100);
                const scoreText = clone.querySelector('.sentiment-score-text');
                const scoreBar = clone.querySelector('.sentiment-bar');

                scoreText.textContent = `${score}%`;
                scoreBar.style.width = `${score}%`;

                if (review.sentiment === 'positive') scoreBar.classList.add('bg-green-500');
                else if (review.sentiment === 'negative') scoreBar.classList.add('bg-red-500');
                else scoreBar.classList.add('bg-yellow-500');

                // Colorize text based on score
                if (score >= 75) scoreText.classList.add('text-green-600');
                else if (score <= 40) scoreText.classList.add('text-red-600');
                else scoreText.classList.add('text-yellow-600');

                // Response Logic
                const statusBadge = clone.querySelector('.response-status-badge');
                const replyBtn = clone.querySelector('.reply-btn');

                if (review.responseStatus === 'responded') {
                    statusBadge.innerHTML = '<i class="fa-solid fa-check-double mr-1"></i> Responded';
                    statusBadge.className = 'response-status-badge text-xs font-medium px-2.5 py-1 rounded bg-blue-50 text-blue-700';
                    replyBtn.classList.add('hidden'); // Hide reply button if already responded (for MVP)
                } else {
                    replyBtn.addEventListener('click', () => openReplyModal(review));
                }

                container.appendChild(clone);
            });
        }

        // 4. Utility / Events
        function showLoading(show) {
            document.getElementById('loadingIndicator').classList.toggle('hidden', !show);
            if (show) {
                document.getElementById('reviewsContainer').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');
            }
        }

        function setupEventListeners() {
            document.getElementById('branchSelector').addEventListener('change', renderDashboard);
            document.getElementById('filterStatus').addEventListener('change', renderDashboard);
            document.getElementById('filterSentiment').addEventListener('change', renderDashboard);
            document.getElementById('refreshBtn').addEventListener('click', fetchReviews);
        }

        // Start the app
        init();

        // 5. Modal & Reply Logic
        const modal = document.getElementById('replyModal');
        const replyForm = document.getElementById('replyForm');

        function openReplyModal(review) {
            document.getElementById('modalReviewId').value = review.id;
            document.getElementById('modalReviewText').textContent = `"${review.reviewText}"`;
            document.getElementById('replyMessage').value = '';
            modal.classList.remove('hidden');
        }

        function closeReplyModal() {
            modal.classList.add('hidden');
            replyForm.reset();
        }

        document.getElementById('closeModalBtn').addEventListener('click', closeReplyModal);
        document.getElementById('cancelModalBtn').addEventListener('click', closeReplyModal);

        replyForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submitReplyBtn');
            const originalBtnHtml = submitBtn.innerHTML;

            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Sending...';

                const reviewId = document.getElementById('modalReviewId').value;
                const responseText = document.getElementById('replyMessage').value;

                // 1. Create Response Document
                await addDoc(collection(db, "responses"), {
                    reviewId: reviewId,
                    responseText: responseText,
                    autoGenerated: false,
                    respondedBy: "Admin User", // Static for MVP
                    respondedAt: serverTimestamp()
                });

                // 2. Update Review Document's responseStatus
                const reviewRef = doc(db, "reviews", reviewId);
                await updateDoc(reviewRef, {
                    responseStatus: "responded"
                });

                // 3. Update local state and UI
                const reviewIndex = allReviews.findIndex(r => r.id === reviewId);
                if (reviewIndex !== -1) {
                    allReviews[reviewIndex].responseStatus = "responded";
                }

                closeReplyModal();
                renderDashboard(); // Re-render to show updated badge

            } catch (error) {
                console.error("Error submitting response:", error);
                alert("Failed to save response. Check console for details.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnHtml;
            }
        });

    </script>
</body>

</html>